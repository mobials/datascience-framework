---
# tasks file for airflow

- name: Make sure the /etc/airflow directory exists
  file:
    path: /etc/airflow
    state: directory
    owner: airflow
    group: airflow
    mode: 0775

- name: Install airflow
  pip: 
    executable: /usr/bin/pip3
    name: "{{ airflow.pip_package }}"
  environment:
    AIRFLOW_HOME: /etc/airflow

- name: Create airflow environment file
  template:
    src: .env.airflow.j2
    dest: /etc/airflow/.env
    owner: airflow
    group: airflow
    mode: '0644'

- name: Init the airflow db
  command: airflow initdb
  environment:
    AIRFLOW_HOME: /etc/airflow
    AIRFLOW__CORE__SQL_ALCHEMY_CONN: postgresql://airflow:airflow@localhost:5432/airflow
    AIRFLOW__CORE__EXECUTOR: LocalExecutor

# - name: Create the airflow webserver service
# - name: Create the airflow scheduler service
# - name: Configure Dags

